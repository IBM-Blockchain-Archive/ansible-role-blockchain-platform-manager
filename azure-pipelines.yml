#
# SPDX-License-Identifier: Apache-2.0
#
---
trigger:
  - master

pool:
  vmImage: "ubuntu-latest"

steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: "3.x"
    displayName: Use Python 3.x
  - script: pip install ansible ansible-lint docker yamllint
    displayName: Install Python dependencies
  - script: |
      set -ex
      ansible-lint . || true
      yamllint .
    displayName: Lint
  - script: docker/build.sh
    displayName: Build Docker image
  - script: |
      set -ex
      ansible-galaxy login --github-token=$(GitHub Token)
      ansible-galaxy import IBM-Blockchain ansible-role-blockchain-platform-manager
    condition: ne(variables['Build.Reason'], 'PullRequest')
    displayName: Publish to Ansible Galaxy